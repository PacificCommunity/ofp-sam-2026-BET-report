name: BET-2026 Report Pipeline

on:
  workflow_dispatch:
    inputs:
      run_mode:
        description: "Select pipeline mode"
        required: true
        default: "full"
        type: choice
        options:
          - full
          - plots_only
          - report_only
      version_note:
        description: "Optional note for this release"
        required: false
        default: ""
  push:
    branches: [main]

jobs:
  build-and-release:
    runs-on: ubuntu-22.04
    env:
      # Use repository variable, fallback to 'true'
      RUN_PIPELINE: ${{ vars.RUN_PIPELINE || 'true' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # Debug to confirm RUN_PIPELINE
      - name: Debug RUN_PIPELINE
        run: echo "RUN_PIPELINE='${RUN_PIPELINE}'"

      # Skip push if automatic execution is off
      - name: Skip push if RUN_PIPELINE=false
        if: ${{ github.event_name == 'push' && env.RUN_PIPELINE != 'true' }}
        run: |
          echo "Automatic execution is disabled. Exiting."
          exit 0

      # Pull Docker image only if workflow_dispatch OR RUN_PIPELINE=true
      - name: Pull BET-2026 Docker image
        if: ${{ github.event_name == 'workflow_dispatch' || env.RUN_PIPELINE == 'true' }}
        run: docker pull ghcr.io/pacificcommunity/bet-2026:v1.2

      # Setup Quarto for rendering Pre-PAW document
      - name: Set up Quarto
        if: ${{ github.event_name == 'workflow_dispatch' || env.RUN_PIPELINE == 'true' }}
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: 1.4.554

      # Render Pre-PAW Quarto document
      - name: Render Pre-PAW Quarto document
        if: ${{ github.event_name == 'workflow_dispatch' || env.RUN_PIPELINE == 'true' }}
        run: |
          quarto render Pre-PAW/prepaw_bet2026.qmd --to html

      # Run pipeline
      - name: Run BET-2026 pipeline
        if: ${{ github.event_name == 'workflow_dispatch' || env.RUN_PIPELINE == 'true' }}
        run: |
          MODE="${{ github.event.inputs.run_mode }}"
          if [ "$MODE" = "plots_only" ]; then
            make docker-plot_sens
            make docker-plot_grid
          elif [ "$MODE" = "report_only" ]; then
            make docker-report
          else
            make docker-plot_sens
            make docker-plot_grid
            make docker-report
          fi

      # Compile Pre-PAW presentation
      - name: Compile Pre-PAW presentation
        if: ${{ github.event_name == 'workflow_dispatch' || env.RUN_PIPELINE == 'true' }}
        run: |
          docker run --rm \
            -v "$(pwd):/workspace" \
            -w /workspace/Pre-PAW \
            ghcr.io/pacificcommunity/bet-2026:v1.2 \
            quarto render prepaw_bet2026.qmd

      # Prepare release directory
      - name: Prepare release directory
        if: ${{ github.event_name == 'workflow_dispatch' || env.RUN_PIPELINE == 'true' }}
        run: |
          mkdir -p public
          cp report/bet-2026.pdf public/ || true
          cp plot/plots_sens.html public/ || true
          cp plot/plots_grid.html public/ || true
          cp Pre-PAW/prepaw_bet2026.html public/prepaw.html || true

      # Deploy to GitHub Pages via gh CLI
      - name: Deploy to GitHub Pages via gh CLI
        if: ${{ github.event_name == 'workflow_dispatch' || env.RUN_PIPELINE == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Fetch and checkout gh-pages
          git fetch origin gh-pages || true
          git checkout -B gh-pages
          
          # Remove all files completely (including hidden files except .git)
          git rm -rf . || true
          find . -maxdepth 1 ! -name '.git' ! -name '.' ! -name '..' -exec rm -rf {} + 2>/dev/null || true
          
          # Copy new files
          cp -r public/* .
          
          # Add cache-busting meta tags to HTML files
          for file in *.html; do
            if [ -f "$file" ]; then
              # Check if meta tags already exist to avoid duplication
              if ! grep -q "Cache-Control" "$file"; then
                sed -i '/<head>/a\  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">\n  <meta http-equiv="Pragma" content="no-cache">\n  <meta http-equiv="Expires" content="0">' "$file"
              fi
            fi
          done
          
          # Commit with unique timestamp to force update
          git add .
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          git commit -m "Update GitHub Pages content - $TIMESTAMP" --allow-empty
          git push -f origin gh-pages

      # Create unique version tag
      - name: Create version tag
        if: ${{ github.event_name == 'workflow_dispatch' || env.RUN_PIPELINE == 'true' }}
        id: tag
        run: |
          DATE=$(date +'%Y%m%d')
          BASE_TAG="v${DATE}"
          git fetch --tags
          COUNT=0
          TAG="$BASE_TAG"
          while git ls-remote --tags origin | grep -q "refs/tags/$TAG"; do
            COUNT=$((COUNT + 1))
            TAG="${BASE_TAG}-$COUNT"
          done
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          git tag "$TAG"
          git push origin "$TAG"

      # Delete old release assets if release exists
      - name: Delete old release assets
        if: ${{ github.event_name == 'workflow_dispatch' || env.RUN_PIPELINE == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          
          # Check if release exists
          if gh release view "$TAG" &>/dev/null; then
            echo "Release $TAG exists, deleting old assets..."
            gh release delete-asset "$TAG" prepaw_bet2026.html -y || true
            gh release delete-asset "$TAG" bet-2026.pdf -y || true
            gh release delete-asset "$TAG" plots_sens.html -y || true
            gh release delete-asset "$TAG" plots_grid.html -y || true
          else
            echo "Release $TAG does not exist yet, skipping asset deletion"
          fi

      # Create GitHub Release
      - name: Create GitHub Release
        if: ${{ github.event_name == 'workflow_dispatch' || env.RUN_PIPELINE == 'true' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: BET-2026 Report ${{ steps.tag.outputs.tag }}
          body: |
            ## BET-2026 Automated Report
            **Mode:** ${{ github.event.inputs.run_mode || 'full' }}
            **Generated:** ${{ github.event.head_commit.timestamp || github.run_id }}
            ${{ github.event.inputs.version_note }}

            **View online:**  
            - [Pre-PAW Presentation](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/prepaw.html)
            - [Sensitivity Plots](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/plots_sens.html)  
            - [Grid Plots](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/plots_grid.html)  
            - [PDF Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/bet-2026.pdf)
          files: |
            Pre-PAW/prepaw_bet2026.html
            report/bet-2026.pdf
            plot/plots_sens.html
            plot/plots_grid.html
          fail_on_unmatched_files: false

      # Cleanup old deployments (keep last 30 min)
      - name: Cleanup old deployments (keep last 30 min)
        if: ${{ github.event_name == 'workflow_dispatch' || env.RUN_PIPELINE == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          NOW=$(date -u +%s)
          DEPLOYMENTS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            https://api.github.com/repos/${GITHUB_REPOSITORY}/deployments \
            | jq -c '.[] | {id: .id, created_at: .created_at}')
          echo "$DEPLOYMENTS" | while read deployment; do
            ID=$(echo "$deployment" | jq -r '.id')
            CREATED_TS=$(date -d "$(echo "$deployment" | jq -r '.created_at')" +%s)
            if [ $((NOW - CREATED_TS)) -gt 1800 ]; then
              echo "Deleting deployment $ID"
              curl -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
                https://api.github.com/repos/${GITHUB_REPOSITORY}/deployments/$ID
            fi
          done

      # Cleanup old releases (keep last 30 days)
      - name: Cleanup old releases (keep last 30 days)
        if: ${{ github.event_name == 'workflow_dispatch' || env.RUN_PIPELINE == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          NOW=$(date -u +%s)
          RELEASES=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            https://api.github.com/repos/${GITHUB_REPOSITORY}/releases \
            | jq -c '.[] | {id: .id, created_at: .created_at}')
          echo "$RELEASES" | while read release; do
            ID=$(echo "$release" | jq -r '.id')
            CREATED_TS=$(date -d "$(echo "$release" | jq -r '.created_at')" +%s)
            if [ $((NOW - CREATED_TS)) -gt 2592000 ]; then
              echo "Deleting release $ID"
              curl -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
                https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/$ID
            fi
          done


